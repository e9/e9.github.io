<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    

    <title>gomobileで非同期な関数を扱いたい - e9.github.io</title>

    


    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/styles.css" />
  </head>

  <body>
    <nav
      class="navbar "
    >
      <div class="container">
        <a
          class="navbar-brand"
          href="https://e9.github.io"
          style="font-weight: 800; font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; "
          >e9.github.io</a
        >
      </div>
    </nav>

    

    <main class="container">
      <div class="row">
        <div class="col-md-9">
<article>
    
    <h2 class="post-item post-title">
        <a href="https://e9.github.io/posts/1548328800/">gomobileで非同期な関数を扱いたい</a>
    </h2>
    <div class="post-item post-meta">
        <span
  ><ion-icon name="today"></ion-icon>&nbsp;2019-01-24</span
><span
  ><ion-icon name="pricetags"></ion-icon
  >&nbsp;No tag</span
>

    </div>
    
    
    <div class="post-content markdown-body">
        <p>gomobileでiOS向けのライブラリを書いている。</p>
<pre><code>$ gomobile version
gomobile version +dc07713 Mon Jan 7 16:22:57 2019 +0000 (android,ios); androidSDK=
</code></pre>
<pre><code class="language-go">package main

import &quot;app/x&quot;

func main() {
	x.X()
}
</code></pre>
<pre><code class="language-go">package x

func X() {
}
</code></pre>
<p>この関数Xが非同期で動くとして、その結果をメインに返したいとき、セオリーとしてはコールバックの追加だろう。</p>
<pre><code class="language-go">package main

import (
	&quot;app/x&quot;
	&quot;log&quot;
)

func main() {
	c := make(chan struct{}, 0)

	x.X(func() {
		log.Println(&quot;two&quot;)
		close(c)
	})

	log.Println(&quot;one&quot;)
	&lt;-c
}
</code></pre>
<pre><code class="language-go">package x

import &quot;time&quot;

func X(callback func()) {
	go (func() {
		time.Sleep(1 * time.Second)
		callback()
	})()
}
</code></pre>
<p>ところがどっこいこの関数はgomobile bindの対象にはならないのだ。</p>
<pre><code>// skipped function X with unsupported parameter or return types
</code></pre>
<p>関数はよくても関数型はだめらしい。</p>
<ul>
<li><a href="https://godoc.org/golang.org/x/mobile/cmd/gobind#hdr-Type_restrictions">https://godoc.org/golang.org/x/mobile/cmd/gobind#hdr-Type_restrictions</a></li>
</ul>
<p>どうするかというとinterfaceを使う。</p>
<pre><code class="language-go">package x

import &quot;time&quot;

type I interface {
	Callback()
}

func X(p I) {
	go (func() {
		time.Sleep(1 * time.Second)
		p.Callback()
	})()
}
</code></pre>
<p>このとき生成されたX.objc.hにはXIプロトコルと共に、同名のクラスが定義されているので</p>
<pre><code class="language-objc">@protocol XI;
@class XI;
</code></pre>
<p>Swiftでコールバック用のクラスを実装する場合はXIではなくXIProtocolを継承する必要がある。</p>
<pre><code class="language-swift">class Callback: NSObject, XIProtocol {
</code></pre>
<p>この罠にうっかりハマって大変だった。</p>

    </div>
</article>



</div>
        <aside class="col-md-3"><aside>
  <div>
    <ul class="list-unstyled">
      

      <li>
        <a href="/">Home</a>
      </li>
      

      <li>
        <a href="/index.xml">RSS</a>
      </li>
      

    </ul>
  </div>

  <div>
    <ul class="list-unstyled">
      

      <li>
        <a href="/archives/2020/04/">2020/04</a>
      </li>
      

      <li>
        <a href="/archives/2019/01/">2019/01</a>
      </li>
      

      <li>
        <a href="/archives/2018/12/">2018/12</a>
      </li>
      

      <li>
        <a href="/archives/2018/11/">2018/11</a>
      </li>
      

      <li>
        <a href="/archives/2018/10/">2018/10</a>
      </li>
      

      <li>
        <a href="/archives/2018/09/">2018/09</a>
      </li>
      

      <li>
        <a href="/archives/2018/08/">2018/08</a>
      </li>
      

      <li>
        <a href="/archives/2016/05/">2016/05</a>
      </li>
      

      <li>
        <a href="/archives/2016/03/">2016/03</a>
      </li>
      

      <li>
        <a href="/archives/2016/02/">2016/02</a>
      </li>
      

      <li>
        <a href="/archives/2014/04/">2014/04</a>
      </li>
      

      <li>
        <a href="/archives/2014/03/">2014/03</a>
      </li>
      

      <li>
        <a href="/archives/2012/08/">2012/08</a>
      </li>
      

      <li>
        <a href="/archives/2012/07/">2012/07</a>
      </li>
      

      <li>
        <a href="/archives/2012/06/">2012/06</a>
      </li>
      

      <li>
        <a href="/archives/2012/05/">2012/05</a>
      </li>
      

      <li>
        <a href="/archives/2012/04/">2012/04</a>
      </li>
      

    </ul>
  </div>

  <div>
    <ul class="list-unstyled">
      

      <li>
        <a href="https://github.com/e9" target="_blank">GitHub</a>
      </li>
      

      <li>
        <a href="https://twitter.com/sfc" target="_blank">Twitter</a>
      </li>
      

    </ul>
  </div>
</aside>
</aside>
      </div>
    </main>

    <footer></footer>
  </body>
</html>
